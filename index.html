<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Alcans - Sistema de Gestão</title>
    <script src="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --alcans-orange: #FE5000;
            --alcans-green: #00c853; 
            --alcans-red: #ff3d00;
            --bg-main: #000000;
            --bg-panel: #121212;
            --bg-element: #1e1e1e;
            --text-gray: #888888;
            --radius-pill: 50px;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0; 
            background: var(--bg-main); color: white; 
            height: 100vh; display: flex; flex-direction: column; 
            overflow: hidden; 
        }
        
        /* HEADER */
        header { 
            background: var(--bg-main); padding: 15px 25px; 
            display: flex; justify-content: space-between; align-items: center; 
            z-index: 10; border-bottom: 1px solid #222;
        }

        /* BOTÃO VISÃO GERAL */
        .btn-overview {
            background: #222; color: white; border: 1px solid #444;
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .btn-overview:hover, .btn-overview.active {
            background: var(--alcans-orange); border-color: var(--alcans-orange);
            box-shadow: 0 0 15px rgba(254, 80, 0, 0.3);
        }

        /* DASHBOARD OVERLAY */
        #overview-panel {
            position: absolute; top: 120px; left: 0; width: 100%; bottom: 0;
            background: var(--bg-main); z-index: 500;
            display: none; padding: 20px; box-sizing: border-box; overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        #overview-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-grid {
            display: grid; grid-template-columns: 200px repeat(6, 1fr); gap: 10px;
            max-width: 1400px; margin: 0 auto;
        }
        .dash-header {
            background: #181818; padding: 15px; border-radius: 10px;
            text-align: center; font-weight: 800; color: #666; font-size: 12px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .colab-row-header {
            background: #1e1e1e; padding: 20px; border-radius: 15px;
            display: flex; align-items: center; gap: 10px;
            font-weight: 700; color: white; border-left: 4px solid var(--alcans-orange);
        }
        .dash-card {
            background: #111; border: 1px solid #222; border-radius: 15px;
            padding: 15px; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 80px; position: relative;
        }
        .dash-card:hover { border-color: #555; background: #1a1a1a; transform: translateY(-2px); }
        .status-empty { color: #444; font-size: 11px; font-weight: 600; }
        .status-active { border-color: var(--alcans-green); background: rgba(0, 200, 83, 0.05); }
        .card-count { font-size: 24px; font-weight: 800; color: white; }
        .card-label { font-size: 10px; color: #888; text-transform: uppercase; margin-top: 4px; }
        .status-badge { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; border-radius: 50%; }
        .badge-saved { background: var(--alcans-green); box-shadow: 0 0 5px var(--alcans-green); }

        /* NAVEGADOR */
        .week-navigator { display: flex; align-items: center; justify-content: center; gap: 15px; background: #181818; padding: 10px; border-bottom: 1px solid #333; }
        .week-display { font-size: 14px; font-weight: 700; color: white; display: flex; flex-direction: column; align-items: center; min-width: 150px; }
        .week-dates { font-size: 11px; color: var(--alcans-orange); font-weight: 400; margin-top: 2px; }
        .btn-nav-arrow { background: #2a2a2a; color: #fff; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-nav-arrow:hover { background: var(--alcans-orange); }
        .top-actions { display: flex; gap: 10px; margin-left: 20px; }
        .btn-top { font-size: 10px; padding: 6px 14px; background: #2a2a2a; border: 1px solid #444; color: #aaa; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .btn-top:hover { border-color: var(--alcans-orange); color: white; }
        .btn-excel { border-color: #217346; color: #217346; } .btn-excel:hover { background: #217346; color: white; border-color: #217346; }

        .nav-container { background: var(--bg-main); padding: 10px 20px; display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .tab-colab { padding: 8px 18px; background: var(--bg-element); border: 1px solid #333; color: var(--text-gray); border-radius: var(--radius-pill); cursor: pointer; font-weight: 700; font-size: 11px; text-transform: uppercase; white-space: nowrap; transition: 0.3s; }
        .tab-colab.active { background: var(--alcans-orange); color: white; border-color: var(--alcans-orange); }
        .nav-days { display: flex; padding: 10px 20px; gap: 8px; background: var(--bg-main); border-bottom: 1px solid #222; overflow-x: auto; }
        .btn-day { padding: 8px 16px; background: transparent; border: 2px solid #333; color: var(--text-gray); border-radius: var(--radius-pill); cursor: pointer; font-size: 10px; font-weight: 800; transition: 0.3s; }
        .btn-day.active { background: white; color: black; border-color: white; }

        .main { display: grid; grid-template-columns: 340px 1fr; flex: 1; overflow: hidden; position: relative; }
        .sidebar { background: var(--bg-panel); display: flex; flex-direction: column; margin: 10px; border-radius: 20px; overflow: hidden; border: 1px solid #222; }
        .stats { padding: 20px; background: linear-gradient(135deg, rgba(254, 80, 0, 0.1), transparent); border-bottom: 1px solid #222; }
        .stats-time { font-size: 32px; font-weight: 900; color: var(--alcans-orange); }
        .city-list { padding: 15px; overflow-y: auto; flex: 1; }
        
        .city-item { display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: var(--bg-element); border-radius: var(--radius-pill); border: 1px solid #333; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; }
        .city-item:hover { background: #2a2a2a; border-color: #555; }
        .city-item.fixed { border-left: 6px solid var(--alcans-orange); border-radius: 12px; }
        .city-item.locked { opacity: 0.4; pointer-events: none; border-color: transparent; }
        .city-item.extra { border-style: dashed; border-color: #444; opacity: 0.8; }
        .city-item.extra:hover { opacity: 1; border-style: solid; }
        
        .city-item input[type="checkbox"] { appearance: none; width: 18px; height: 18px; border: 2px solid #555; border-radius: 50%; margin-right: 12px; display: grid; place-content: center; flex-shrink: 0; }
        .city-item input[type="checkbox"]::before { content: ""; width: 10px; height: 10px; border-radius: 50%; transform: scale(0); background: white; transition: 0.2s; }
        .city-item input[type="checkbox"]:checked { border-color: var(--alcans-orange); background: var(--alcans-orange); }
        .city-item input[type="checkbox"]:checked::before { transform: scale(1); }

        .extra-separator { margin: 15px 0 10px 0; padding: 10px; border-top: 1px solid #333; color: #666; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; display: flex; justify-content: space-between; }
        .extra-container { display: none; } .extra-container.open { display: block; }
        
        #map { flex: 1; border-radius: 20px 0 0 0; overflow: hidden; margin-top: 10px; position: relative; }
        
        #floating-controls { position: absolute; bottom: 40px; right: 40px; display: flex; gap: 15px; z-index: 100; }
        .fab { border: none; color: white; font-weight: 800; text-transform: uppercase; font-size: 12px; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
        .fab-save { height: 60px; padding: 0 30px; border-radius: 30px; background: var(--alcans-orange); gap: 10px; }
        .fab-save.locked-state { background: #2a2a2a; color: #666; pointer-events: none; }
        .fab-delete { width: 60px; height: 60px; border-radius: 50%; background: #2a2a2a; border: 2px solid var(--alcans-red); color: var(--alcans-red); font-size: 18px; }

        #confirm-modal { position: absolute; bottom: 110px; right: 40px; background: #1a1a1a; border: 1px solid #333; border-radius: 20px; padding: 20px; width: 280px; opacity: 0; visibility: hidden; transition: 0.3s; z-index: 2000; }
        #confirm-modal.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .btn-confirm { padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: 800; cursor: pointer; border: none; margin-left: 5px; }
        .btn-cancel { background: #333; color: #ccc; } .btn-danger { background: var(--alcans-red); color: white; }
        
        #toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100px); padding: 12px 30px; border-radius: var(--radius-pill); font-weight: 700; font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.7); z-index: 9999; opacity: 0; visibility: hidden; transition: 0.4s; display: flex; gap: 10px; }
        #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        .toast-success { background: var(--alcans-green); color: black; } .toast-delete { background: var(--alcans-red); color: white; }
        
        .marker-dark { display: flex; flex-direction: column; align-items: center; }
        .dark-label { background: #111; color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 6px; border: 2px solid var(--alcans-orange); }
        .dark-icon { color: var(--alcans-orange); font-size: 30px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); }
    </style>
</head>
<body>

<header>
    <div style="font-weight:900; color:var(--alcans-orange); font-size: 20px;">ALCANS <span style="font-weight:300; color:white">SYSTEM</span></div>
    
    <button class="btn-overview" id="btnToggleOverview" onclick="toggleOverview()">
        <i class="fas fa-th-large"></i> Visão Geral
    </button>
</header>

<div class="week-navigator">
    <button class="btn-nav-arrow" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
    <div class="week-display">
        <span id="weekTitle">SEMANA ATUAL</span>
        <span id="weekDates" class="week-dates">--/-- - --/--</span>
    </div>
    <button class="btn-nav-arrow" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
    
    <div class="top-actions">
        <button class="btn-top" onclick="clonePreviousWeek()"><i class="fas fa-copy"></i> Copiar</button>
        <button class="btn-top btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
    </div>
</div>

<div class="nav-container" id="colabNav"></div>
<div class="nav-days" id="dayNav"></div>

<div class="main">
    <aside class="sidebar">
        <div class="stats">
            <div id="totalTime" class="stats-time">0h 00m</div>
            <div id="totalKm" style="color: var(--text-gray); font-size: 13px;">0.0 km</div>
        </div>
        <div class="city-list" id="cityList"></div>
    </aside>
    
    <div id="map">
        <div id="overview-panel">
            <h2 style="text-align:center; color:white; margin-bottom:30px">RESUMO DA ESCALA SEMANAL</h2>
            <div class="dashboard-grid" id="dashboardGrid"></div>
        </div>

        <div id="confirm-modal">
            <div style="font-size:14px; font-weight:700; color:white; margin-bottom:5px">Atenção</div>
            <div style="font-size:12px; color:#aaa; margin-bottom:15px">Excluir e desbloquear esta rota?</div>
            <div style="display:flex; justify-content:flex-end">
                <button class="btn-confirm btn-cancel" onclick="closeConfirmModal()">Cancelar</button>
                <button class="btn-confirm btn-danger" onclick="executeDelete()">Excluir</button>
            </div>
        </div>

        <div id="floating-controls">
            <button class="fab fab-delete" onclick="openConfirmModal()"><i class="fas fa-trash-alt"></i></button>
            <button id="btnSave" class="fab fab-save" onclick="saveCurrentRoute()">
                <i class="fas fa-save"></i> <span>SALVAR</span>
            </button>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    const days = ["SEGUNDA", "TERÇA", "QUARTA", "QUINTA", "SEXTA", "SÁBADO"];
    let currentWeekOffset = 0; 
    let activeWeek = getWeekRange(0);
    
    function getWeekRange(offset) {
        const today = new Date();
        const currentDay = today.getDay();
        const diffToMonday = currentDay === 0 ? -6 : 1 - currentDay;
        const monday = new Date(today); monday.setDate(today.getDate() + diffToMonday + (offset * 7));
        const saturday = new Date(monday); saturday.setDate(monday.getDate() + 5);
        const oneJan = new Date(monday.getFullYear(), 0, 1);
        const weekNum = Math.ceil((monday.getDay() + 1 + Math.floor((monday - oneJan) / (24 * 60 * 60 * 1000))) / 7);
        const weekId = `${monday.getFullYear()}-W${weekNum.toString().padStart(2, '0')}`;
        return { monday, saturday, display: `${monday.getDate()}/${monday.getMonth()+1} - ${saturday.getDate()}/${saturday.getMonth()+1}`, id: weekId };
    }

    let db = JSON.parse(localStorage.getItem('alcans_system_final')) || {};

    const colabs = {
        "1": { nome: "GUSTAVO (C1)", partida: "Cajuru", cidades: ["Cajuru", "Cássia dos Coqueiros", "Santa Cruz da Esperança", "Santa Rosa de Viterbo (centro)", "Batatais", "Mococa"] },
        "2": { nome: "QUELI (C2)", partida: "Santo Antonio da Alegria", cidades: ["Santo Antonio da Alegria", "Itamogi", "Arceburgo", "Guaxupé", "Monte Santo de Minas", "São Sebastião do Paraíso"] },
        "3": { nome: "IGOR (C3)", partida: "Ribeirão Preto", cidades: ["Ribeirão Preto", "Guariba", "Jaboticabal", "Jardinopolis"] },
        "4": { nome: "NOVO LÍDER (C4)", partida: "São Carlos", cidades: ["São Carlos", "Santa Rita do Passa Quatro", "Tambaú", "Santa Cruz das Palmeiras"] }
    };
    const coords = { "Cajuru": [-47.3039, -21.2747], "Cássia dos Coqueiros": [-47.1697, -21.2811], "Santa Cruz da Esperança": [-47.4267, -21.2917], "Santa Rosa de Viterbo (centro)": [-47.3622, -21.4722], "Batatais": [-47.5847, -20.8914], "Mococa": [-47.0019, -21.4644], "Santo Antonio da Alegria": [-47.1517, -21.0872], "Itamogi": [-47.0519, -21.0711], "Arceburgo": [-46.9389, -21.3639], "Guaxupé": [-46.7111, -21.3053], "Monte Santo de Minas": [-46.9806, -21.1897], "São Sebastião do Paraíso": [-46.9914, -20.9169], "Ribeirão Preto": [-47.8103, -21.1706], "Guariba": [-48.2267, -21.3597], "Jaboticabal": [-48.3242, -21.2558], "Jardinopolis": [-47.8267, -21.0208], "São Carlos": [-47.8908, -22.0175], "Santa Rita do Passa Quatro": [-47.4772, -21.7081], "Tambaú": [-47.2736, -21.7042], "Santa Cruz das Palmeiras": [-47.2856, -21.8256] };

    let currentColab = "1", currentDay = "SEGUNDA", currentSelection = [], isLocked = false, extraExpanded = false;
    const map = new maplibregl.Map({ container: 'map', style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json', center: [-47.3, -21.2], zoom: 9.5, pitch: 40 });

    function toggleOverview() {
        const panel = document.getElementById('overview-panel'); const btn = document.getElementById('btnToggleOverview');
        if (panel.classList.contains('active')) { panel.classList.remove('active'); btn.classList.remove('active'); btn.innerHTML = '<i class="fas fa-th-large"></i> Visão Geral'; }
        else { renderDashboard(); panel.classList.add('active'); btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-times"></i> Fechar Visão'; }
    }

    function renderDashboard() {
        const grid = document.getElementById('dashboardGrid'); grid.innerHTML = ''; const week = activeWeek.id;
        grid.innerHTML += `<div class="dash-header">COLABORADOR</div>`;
        days.forEach(d => grid.innerHTML += `<div class="dash-header">${d.substring(0,3)}</div>`);
        Object.keys(colabs).forEach(cId => {
            grid.innerHTML += `<div class="colab-row-header"><i class="fas fa-user-circle"></i> ${colabs[cId].nome.split(' ')[0]}</div>`;
            days.forEach(day => {
                const route = db[week]?.[cId]?.[day]; const hasRoute = route && route.length > 0;
                const count = hasRoute ? route.length - 1 : 0;
                grid.innerHTML += hasRoute ? 
                    `<div class="dash-card status-active" onclick="jumpTo('${cId}', '${day}')"><div class="status-badge badge-saved"></div><div class="card-count">${count}</div><div class="card-label">Cidades</div></div>` :
                    `<div class="dash-card" onclick="jumpTo('${cId}', '${day}')"><span class="status-empty">- LIVRE -</span></div>`;
            });
        });
    }

    function jumpTo(cId, day) {
        document.getElementById('overview-panel').classList.remove('active');
        document.getElementById('btnToggleOverview').classList.remove('active');
        document.getElementById('btnToggleOverview').innerHTML = '<i class="fas fa-th-large"></i> Visão Geral';
        currentColab = cId; currentDay = day; loadState(); updateUI();
    }

    function initUI() {
        const colabNav = document.getElementById('colabNav'); const dayNav = document.getElementById('dayNav');
        Object.keys(colabs).forEach(id => { const btn = document.createElement('button'); btn.className = 'tab-colab'; btn.id = `c-${id}`; btn.innerText = colabs[id].nome; btn.onclick = () => { currentColab = id; loadState(); updateUI(); }; colabNav.appendChild(btn); });
        days.forEach(d => { const btn = document.createElement('button'); btn.className = 'btn-day'; btn.id = `d-${d}`; btn.innerText = d.substring(0,3); btn.onclick = () => { currentDay = d; loadState(); updateUI(); }; dayNav.appendChild(btn); });
        updateWeekDisplay();
    }

    function updateWeekDisplay() {
        activeWeek = getWeekRange(currentWeekOffset);
        document.getElementById('weekDates').innerText = activeWeek.display;
        document.getElementById('weekTitle').innerText = currentWeekOffset === 0 ? "SEMANA ATUAL" : (currentWeekOffset === 1 ? "PRÓXIMA SEMANA" : (currentWeekOffset === -1 ? "SEMANA PASSADA" : `SEMANA ${activeWeek.id.split('W')[1]}`));
        loadState(); updateUI();
        if(document.getElementById('overview-panel').classList.contains('active')) renderDashboard();
    }
    function changeWeek(dir) { currentWeekOffset += dir; updateWeekDisplay(); }

    function loadState() {
        const week = activeWeek.id;
        if (!db[week]) db[week] = {}; if (!db[week][currentColab]) db[week][currentColab] = {};
        const savedData = db[week][currentColab][currentDay];
        if (savedData && savedData.length > 0) { currentSelection = [...savedData]; isLocked = true; } else { currentSelection = [colabs[currentColab].partida]; isLocked = false; }
    }

    function saveCurrentRoute() {
        if (isLocked) return;
        const week = activeWeek.id; if (!db[week]) db[week] = {}; if (!db[week][currentColab]) db[week][currentColab] = {};
        db[week][currentColab][currentDay] = [...currentSelection];
        localStorage.setItem('alcans_system_final', JSON.stringify(db));
        isLocked = true; renderCities(); updateButtons(); showToast("Rota Salva!", "success");
    }

    function executeDelete() {
        closeConfirmModal(); const week = activeWeek.id;
        if(db[week] && db[week][currentColab]) delete db[week][currentColab][currentDay];
        localStorage.setItem('alcans_system_final', JSON.stringify(db));
        currentSelection = [colabs[currentColab].partida]; isLocked = false;
        renderCities(); updateMapRoute(); updateButtons(); showToast("Rota Excluída!", "delete");
    }

    function clonePreviousWeek() {
        const currentWeekId = activeWeek.id; const prevWeekInfo = getWeekRange(currentWeekOffset - 1);
        if (!db[prevWeekInfo.id]) { showToast("Sem dados anteriores.", "delete"); return; }
        if(!confirm("Copiar semana anterior?")) return;
        db[currentWeekId] = JSON.parse(JSON.stringify(db[prevWeekInfo.id]));
        localStorage.setItem('alcans_system_final', JSON.stringify(db));
        loadState(); updateUI(); showToast("Cópia realizada!", "success");
    }

    function exportToExcel() {
        const weekId = activeWeek.id; const reportData = [];
        Object.keys(colabs).forEach(cId => {
            const colabData = db[weekId]?.[cId] || {};
            days.forEach(day => {
                const route = colabData[day] || ["-"];
                if(route.length > 1) { reportData.push({ "Colaborador": colabs[cId].nome, "Semana": activeWeek.display, "Dia": day, "Rota": route.join(" > "), "Cidades": route.length - 1 }); }
            });
        });
        if (reportData.length === 0) { showToast("Sem dados para exportar.", "delete"); return; }
        const worksheet = XLSX.utils.json_to_sheet(reportData); const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Geral Semanal");
        XLSX.writeFile(workbook, `Planejamento_Geral_${weekId}.xlsx`); showToast("Excel baixado!", "success");
    }

    function toggleCity(c) { if(isLocked) return; const i = currentSelection.indexOf(c); i > -1 ? currentSelection.splice(i,1) : currentSelection.push(c); renderCities(); updateButtons(); updateMapRoute(); }
    function openConfirmModal() { if(!isLocked) { showToast("Nada para excluir", "delete"); return; } document.getElementById('confirm-modal').classList.add('show'); }
    function closeConfirmModal() { document.getElementById('confirm-modal').classList.remove('show'); }
    function showToast(m, t) { const el = document.getElementById('toast'); el.className = ''; el.classList.add(t === 'success' ? 'toast-success' : 'toast-delete'); el.innerHTML = `<i class="fas fa-${t==='success'?'check-circle':'trash-alt'}"></i> ${m}`; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 3000); }
    function updateButtons() { const b = document.getElementById('btnSave'); if(isLocked) { b.innerHTML = '<i class="fas fa-lock"></i> <span>BLOQUEADA</span>'; b.className = 'fab fab-save locked-state'; } else { b.innerHTML = '<i class="fas fa-save"></i> <span>SALVAR</span>'; b.className = 'fab fab-save'; } }
    function toggleExtra() { extraExpanded = !extraExpanded; const c = document.getElementById('extraContainer'); extraExpanded ? c.classList.add('open') : c.classList.remove('open'); }

    function renderCities() {
        const list = document.getElementById('cityList'); list.innerHTML = "";
        const primary = colabs[currentColab].cidades;
        primary.forEach(c => createCityItem(c, list, false));
        const sep = document.createElement('div'); sep.className = 'extra-separator'; sep.innerHTML = `<span><i class="fas fa-globe"></i> Outras Regiões</span> <i class="fas fa-chevron-down"></i>`; sep.onclick = toggleExtra; list.appendChild(sep);
        const extra = document.createElement('div'); extra.id = 'extraContainer'; extra.className = extraExpanded ? 'extra-container open' : 'extra-container';
        Object.keys(coords).sort().forEach(c => { if(!primary.includes(c)) createCityItem(c, extra, true); });
        list.appendChild(extra);
    }
    function createCityItem(c, p, isE) {
        const isP = c === colabs[currentColab].partida; const l = document.createElement('label');
        let cls = `city-item ${isP?'fixed':''} ${isLocked?'locked':''} ${isE?'extra':''}`;
        if(isE && currentSelection.includes(c)) cls += ' selected-extra'; l.className = cls;
        l.innerHTML = `<input type="checkbox" ${currentSelection.includes(c)?'checked':''} ${isP||isLocked?'disabled':''} onchange="toggleCity('${c}')"> ${c}`; p.appendChild(l);
    }
    async function updateMapRoute() {
        markers.forEach(m => m.remove()); markers = [];
        currentSelection.forEach(c => { const el = document.createElement('div'); el.className = 'marker-dark'; el.innerHTML = `<div class="dark-label">${c}</div><div class="dark-icon"><i class="fas fa-map-marker-alt"></i></div>`; markers.push(new maplibregl.Marker({element: el, anchor: 'bottom'}).setLngLat(coords[c]).addTo(map)); });
        if (currentSelection.length < 2) { if(map.getSource('route')) map.getSource('route').setData({type:'FeatureCollection',features:[]}); document.getElementById('totalTime').innerText="0h 00m"; document.getElementById('totalKm').innerText="0.0 km"; return; }
        const waypoints = currentSelection.map(c => `${coords[c][0]},${coords[c][1]}`).join(';');
        try { const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${waypoints}?overview=full&geometries=geojson`); const data = await res.json(); 
            if(data.routes && data.routes[0]) { const r = data.routes[0]; 
                if(map.getSource('route')) map.getSource('route').setData(r.geometry); else { map.addSource('route',{type:'geojson',data:r.geometry}); map.addLayer({id:'route',type:'line',source:'route',paint:{'line-color':'#FE5000','line-width':6,'line-opacity':0.9}}); }
                document.getElementById('totalTime').innerText = Math.floor(r.duration/3600)+"h "+Math.floor((r.duration%3600)/60)+"m"; document.getElementById('totalKm').innerHTML = `<i class="fas fa-route"></i> ${(r.distance/1000).toFixed(1)} km`;
                const b = r.geometry.coordinates.reduce((bb, cc) => bb.extend(cc), new maplibregl.LngLatBounds(r.geometry.coordinates[0], r.geometry.coordinates[0])); map.fitBounds(b, {padding:80, pitch:40});
            } } catch(e){}
    }
    function updateUI() { document.querySelectorAll('.tab-colab').forEach(b => b.classList.toggle('active', b.id === `c-${currentColab}`)); document.querySelectorAll('.btn-day').forEach(b => b.classList.toggle('active', b.id === `d-${currentDay}`)); renderCities(); updateMapRoute(); }
    map.on('load', initUI);
</script>
</body>
</html>
